/*! lightBox - v1.0 - 2013-07-08 11:49:14 PM
* Copyright (c) 2013 Letao; Licensed  */
KISSY.add("gallery/lightBox/1.0/index",function(a,b,c){function d(b){var c=this;this.container=a.one(b.container),this.eles=this.container.all(b.eles),this.layer=a.one(b.layer),this.prev=a.one(b.prev),this.next=a.one(b.next),this.isrun=null,this.init(),d.superclass.constructor.call(c,b)}var e=(b.all,a.DOM),f=a.Event;return a.extend(d,c,{isShow:!1,currentImg:null,log:function(a){console.log(a)},getPos:function(a){var b={},c=a.getBoundingClientRect(),d=e.scrollTop(window),f=e.scrollLeft(window);return b.x=c.left+f,b.y=c.top+d,b},getCenter:function(b,c){var d=this;e.css(e.get("#maskLayer"),"display","none");var f=b.width,g=b.height,h=e.viewportWidth(),i=e.viewportHeight(),j=e.scrollTop(window),k=e.scrollLeft(window),l=f;f=f>h-20?h-20:f,g*=f/l;var m=k+(h-f)/2,n=j+(i-g)/2,o=d.getPos(c),p=e.width(c),q=e.height(c),r=e.get("img",d.layer);e.attr(r,"src","http://img02.taobaocdn.com/tps/i2/T1K7DnXfhXXXc6Yc2r-1-1.gif"),e.attr(r,"width",f),e.attr(r,"height",g),a.all(r).fadeOut(.3),m=0>m?0:m,n=0>n?0:n,d.isShow?(d.isrun&&d.isrun.isRunning()&&d.isrun.stop(),d.isrun=new a.Anim(d.layer,{left:m,top:n,width:f,height:g},.3,"easeIn",function(){e.attr(r,"src",e.attr(b,"src")),a.all(r).fadeIn(.3)}),d.isrun.run()):(e.css(d.layer,"left",o.x+"px"),e.css(d.layer,"top",o.y+"px"),e.css(d.layer,"width",p+"px"),e.css(d.layer,"height",q+"px"),e.css(d.layer,"display","block"),d.isShow=!0,d.isrun&&d.isrun.isRunning()&&d.isrun.stop(),d.isrun=new a.Anim(d.layer,{left:m,top:n,width:f,height:g,borderWidth:"10px"},.3,"easeIn",function(){e.attr(r,"src",e.attr(b,"src")),a.all(r).fadeIn(.3)}),d.isrun.run())},doOnLoad:function(b,c){var d=this,e=new Image;"ie"!=a.UA.shell?e.onload=function(){1==e.complete&&d.getCenter(this,c)}:e.onreadystatechange=function(){("loaded"==e.readyState||"complete"==e.readyState)&&d.getCenter(this,c)},e.onerror=function(){},e.src=b},showLoadMask:function(){var a,b,c=e.get("#maskLayer");if(c)a=(e.viewportWidth()-e.width(c))/2+e.scrollLeft(window),b=(e.viewportHeight()-e.height(c))/2+e.scrollTop(window),e.css(c,"left",a+"px"),e.css(c,"top",b+"px"),e.css(c,"display","block");else{var d=e.create("<div id='maskLayer' class='maskLayer'></div>");e.html(d,"<img src='http://img02.taobaocdn.com/tps/i2/T115PmXipeXXaY1rfd-32-32.gif'>"),e.append(d,e.get("body")),c=e.get("#maskLayer"),a=(e.viewportWidth()-e.width(c))/2+e.scrollLeft(window),b=(e.viewportHeight()-e.height(c))/2+e.scrollTop(window),e.css(c,"left",a+"px"),e.css(c,"top",b+"px")}},doClick:function(){var b=this,c=e.get(".closebtn",b.layer);a.each(b.eles,function(c){f.on(c,"click",function(){return b.currentImg=a.indexOf(this,b.eles),b.showLoadMask(),b.doOnLoad(e.attr(this,"href"),this),!1})}),f.on(c,"click",function(){var c=b.getPos(b.eles[b.currentImg]),d=e.width(b.eles[b.currentImg]),f=e.height(b.eles[b.currentImg]);e.attr(e.get("img",b.layer),"src","http://img02.taobaocdn.com/tps/i2/T1K7DnXfhXXXc6Yc2r-1-1.gif"),new a.Anim(b.layer,{left:c.x,top:c.y,width:d,height:f,borderWidth:0},.2,"easeOut",function(){e.css(b.layer,"display","none"),b.isShow=!1}).run()}),f.on(b.layer,"mouseover",function(){a.UA.ie<=6&&(e.css(b.prev,"height",e.height(b.layer)+"px"),e.css(b.prev,"width",.3*e.width(b.layer)+"px"),e.css(b.next,"height",e.height(b.layer)+"px"),e.css(b.next,"width",.3*e.width(b.layer)+"px")),0!=b.currentImg&&e.css(b.prev,"display","block"),b.currentImg!=b.eles.length-1&&e.css(b.next,"display","block")}),f.on(b.layer,"mouseout",function(){e.css(b.prev,"display","none"),e.css(b.next,"display","none")}),f.on(b.prev,"click",function(){b.currentImg-=1,b.doOnLoad(e.attr(b.eles[b.currentImg],"href"),b.eles[b.currentImg]),0==b.currentImg?e.css(b.prev,"display","none"):e.css(b.prev,"display","block"),e.css(b.next,"display","block")}),f.on(b.next,"click",function(){b.currentImg+=1,b.doOnLoad(e.attr(b.eles[b.currentImg],"href"),b.eles[b.currentImg]),b.currentImg==b.eles.length-1?e.css(b.next,"display","none"):e.css(b.next,"display","block"),e.css(b.prev,"display","block")}),f.on(document,"keydown",function(a){var d=a.keyCode;if(b.isShow)if(27==d)f.fire(c,"click");else if(37==d){if(0==b.currentImg)return;e.css(e.get("#maskLayer"),"display","block"),f.fire(b.prev,"click")}else if(39==d){if(b.currentImg==b.eles.length-1)return;e.css(e.get("#maskLayer"),"display","block"),f.fire(b.next,"click")}}),f.on(window,"resize",function(){b.isShow&&(b.isrun&&b.isrun.isRunning()&&b.isrun.stop(),b.doOnLoad(e.attr(b.eles[b.currentImg],"href"),b.eles[b.currentImg]))})},init:function(){this.doClick()}},{ATTRS:{}}),d},{requires:["node","base"]});